<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YChat20 - Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="user-info">
                <span id="currentUsername">Loading...</span>
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
            <h1>YChat20</h1>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>Direct Messages</h3>
                    <div class="user-search">
                        <input type="text" id="userSearch" placeholder="Search users...">
                        <button onclick="searchUsers()">Search</button>
                    </div>
                    <div id="userList" class="user-list"></div>
                </div>
            </div>

            <!-- Chat Content -->
            <div class="chat-content">
                <!-- Chat Messages -->
                <div class="messages-container">
                    <div id="messagesArea" class="messages-area">
                        <div class="welcome-message">
                            <p>Welcome to YChat20! Select a user to start chatting.</p>
                        </div>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="message-input-container">
                    <div class="message-input">
                        <input type="text" id="messageInput" placeholder="Type a message..." disabled>
                        <button onclick="sendMessage()" id="sendButton" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status indicator -->
    <div id="connectionStatus" class="connection-status offline">Connecting...</div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        const API_BASE = '';
        let socket = null;
        let currentUser = null;
        let activeChat = null;
        let token = localStorage.getItem('token');

        // Check authentication
        if (!token) {
            window.location.href = '/';
            return;
        }

        // Parse user data
        try {
            currentUser = JSON.parse(localStorage.getItem('user'));
            document.getElementById('currentUsername').textContent = currentUser.username;
        } catch (error) {
            console.error('Error parsing user data:', error);
            logout();
            return;
        }

        // Initialize Socket.IO connection
        function initializeSocket() {
            console.log('Initializing socket connection...');
            updateConnectionStatus('connecting');
            
            socket = io(window.location.origin, {
                auth: {
                    token: token
                },
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: 5
            });

            socket.on('connect', () => {
                console.log('Connected to server - waiting for authentication...');
            });

            socket.on('connected', (data) => {
                console.log('Socket authenticated successfully:', data);
                updateConnectionStatus('online');
                showSuccess('Connected to chat server');
            });

            socket.on('disconnect', (reason) => {
                console.log('Disconnected from server:', reason);
                updateConnectionStatus('offline');
                if (reason === 'io server disconnect') {
                    // Server disconnected us, try to reconnect
                    socket.connect();
                }
            });

            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                updateConnectionStatus('error');
                showError('Failed to connect to server. Please try refreshing the page.');
            });

            socket.on('error', (data) => {
                console.error('Socket error:', data);
                if (data.message && data.message.includes('token')) {
                    // Authentication error - token is invalid
                    showError('Authentication failed: ' + data.message);
                    updateConnectionStatus('error');
                    setTimeout(() => {
                        showError('Your session has expired. Redirecting to login...');
                        setTimeout(logout, 2000);
                    }, 1000);
                } else {
                    showError(data.message || 'An error occurred');
                }
            });

            socket.on('receive_message', (data) => {
                console.log('Received message:', data);
                if (data.success && activeChat && data.message.senderId === activeChat.id) {
                    displayMessage(data.message, false);
                }
            });

            socket.on('message_sent', (data) => {
                console.log('Message sent confirmation:', data);
                if (data.success) {
                    displayMessage(data.message, true);
                }
            });

            // Handle reconnection attempts
            socket.io.on('reconnect_attempt', () => {
                console.log('Attempting to reconnect...');
                updateConnectionStatus('connecting');
            });

            socket.io.on('reconnect', (attemptNumber) => {
                console.log('Reconnected after', attemptNumber, 'attempts');
                updateConnectionStatus('online');
            });

            socket.io.on('reconnect_failed', () => {
                console.error('Failed to reconnect');
                updateConnectionStatus('error');
                showError('Failed to reconnect. Please refresh the page.');
            });
        }

        // Update connection status
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `connection-status ${status}`;
            
            const statusText = {
                'online': 'Connected',
                'offline': 'Disconnected',
                'connecting': 'Connecting...',
                'error': 'Connection Error'
            };
            
            statusEl.textContent = statusText[status] || status;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            if (socket) {
                socket.disconnect();
            }
            window.location.href = '/';
        }

        // Search users - implement actual user search
        async function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.trim();
            if (!searchTerm) {
                showError('Please enter a username to search');
                return;
            }

            if (searchTerm.length < 2) {
                showError('Search query must be at least 2 characters');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/auth/users/search?q=${encodeURIComponent(searchTerm)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    if (data.data.users.length === 0) {
                        showError('No users found');
                        return;
                    }

                    // Display found users
                    data.data.users.forEach(user => {
                        displayUser(user);
                    });

                    document.getElementById('userSearch').value = '';
                    showSuccess(`Found ${data.data.users.length} user(s)`);
                } else {
                    showError(data.message || 'Search failed');
                }
            } catch (error) {
                console.error('Search error:', error);
                showError('Error searching users. Please try again.');
            }
        }

        // Display user in sidebar
        function displayUser(user) {
            const userList = document.getElementById('userList');
            
            // Check if user already exists
            if (document.getElementById(`user-${user.id}`)) {
                return;
            }

            const userElement = document.createElement('div');
            userElement.className = 'user-item';
            userElement.id = `user-${user.id}`;
            userElement.innerHTML = `
                <div class="user-avatar">${user.username[0].toUpperCase()}</div>
                <div class="user-name">${user.username}</div>
            `;
            userElement.onclick = () => selectUser(user);

            userList.appendChild(userElement);
        }

        // Select user to chat with
        function selectUser(user) {
            activeChat = user;
            
            // Update UI
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`user-${user.id}`).classList.add('active');

            // Enable message input
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').placeholder = `Type a message to ${user.username}...`;

            // Clear messages and load chat history
            clearMessages();
            loadChatHistory(user.id);
        }

        // Load chat history
        async function loadChatHistory(userId) {
            try {
                const response = await fetch(`${API_BASE}/api/messages/history/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    data.data.messages.forEach(message => {
                        displayMessage(message, message.senderId === currentUser.id);
                    });
                } else {
                    console.error('Error loading chat history:', data.message);
                }
            } catch (error) {
                console.error('Network error loading chat history:', error);
            }
        }

        // Clear messages
        function clearMessages() {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = '';
        }

        // Display message in chat
        function displayMessage(message, isSent) {
            const messagesArea = document.getElementById('messagesArea');
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
            
            const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageElement.innerHTML = `
                <div class="message-content">${message.content}</div>
                <div class="message-time">${time}</div>
            `;

            messagesArea.appendChild(messageElement);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Send message
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();

            if (!content || !activeChat || !socket) {
                return;
            }

            socket.emit('send_message', {
                receiverId: activeChat.id,
                content: content
            });

            messageInput.value = '';
        }

        // Handle Enter key in message input
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Handle Enter key in search input
        document.getElementById('userSearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchUsers();
            }
        });

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-notification';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-notification';
            successDiv.textContent = message;
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #22c55e;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Initialize the application
        async function initApp() {
            console.log('Initializing app...');
            
            // Verify authentication first
            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    console.error('Auth verification failed');
                    logout();
                    return;
                }

                const userData = await response.json();
                console.log('Auth verified:', userData);

                // Update current user data
                currentUser = userData.data.user;
                document.getElementById('currentUsername').textContent = currentUser.username;

                // Initialize socket connection
                initializeSocket();

                // Add some demo users for testing
                setTimeout(() => {
                    displayUser({ id: 1, username: 'Alice', email: 'alice@example.com' });
                    displayUser({ id: 2, username: 'Bob', email: 'bob@example.com' });
                    displayUser({ id: 3, username: 'Charlie', email: 'charlie@example.com' });
                }, 2000);

            } catch (error) {
                console.error('App initialization error:', error);
                showError('Failed to initialize app. Please refresh the page.');
            }
        }

        // Initialize the application
        initApp();
    </script>
</body>
</html>